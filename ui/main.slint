import { Button, ScrollView } from "std-widgets.slint";

// ✅ Step: new row struct for the UI table (includes Size + Reason)
export struct RowData {
    id: int,
    path: string,
    size: string,
    reason: string,
    decision: string,
}

export component AppWindow inherits Window {
    width: 900px;
    height: 520px;
    title: "Cruft Crawler";

    // ✅ Properties Rust will control
    in property<int> progress_value: 0;
    in property<string> status_text: "Idle";

    in-out property<int> selected_index: -1;

    // ✅ Step: model property for table rows
    in property<[RowData]> rows: [];

    callback load_report();
    callback run_scan();

    VerticalLayout {
        padding: 16px;
        spacing: 12px;

        Text {
            text: "Cruft Crawler";
            font-size: 22px;
        }

        // Status line
        HorizontalLayout {
            spacing: 12px;

            Text { text: "Status:"; }
            Text { text: root.status_text; }
        }

        // ✅ Custom Progress Bar bound to progress_value
        Rectangle {
            height: 8px;
            width: 100%;
            background: #3a3a3a;
            border-radius: 4px;

            Rectangle {
                height: parent.height;
                border-radius: 4px;
                background: #66ff99;

                width: parent.width * root.progress_value / 100;
            }
        }

        // Progress text bound to status_text
        Text {
            text: root.status_text;
            font-size: 12px;
        }

        // Buttons row
        HorizontalLayout {
            spacing: 12px;

            Button {
                text: "Load Report (TSV)";
                clicked => { load_report(); }
            }

            Button {
                text: "Run Scan (later)";
                clicked => { run_scan(); }
            }
        }

        Rectangle { height: 1px; }

        // Table header
        HorizontalLayout {
            spacing: 8px;

            Text { text: "ID"; width: 90px; }
            Text { text: "Path"; width: 430px; }
            Text { text: "Size"; width: 110px; }
            Text { text: "Reason"; width: 140px; }
            Text { text: "Decision"; width: 110px; }
        }

        // Table rows
        ScrollView {
            height: 380px;

            VerticalLayout {
                spacing: 6px;

                // ✅ Step: bind loop to rows model
                for row[i] in rows : Rectangle {
                    height: 26px;
                    background: (i == selected_index) ? #303030 : #00000000;

                    TouchArea {
                        clicked => { selected_index = i; }
                    }

                    HorizontalLayout {
                        spacing: 8px;

                        Text { text: row.id; width: 90px; }
                        Text { text: row.path; width: 430px; }
                        Text { text: row.size; width: 110px; }
                        Text { text: row.reason; width: 140px; }

                        Text {
                            text: row.decision;
                            width: 110px;
                            color: row.decision == "DELETE" ? #ff6b6b
                                 : row.decision == "KEEP"   ? #66ff99
                                 : #ffffff;
                        }
                    }
                }
            }
        }
    }
}
